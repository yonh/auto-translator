var content=function(){"use strict";var pe=Object.defineProperty;var be=(P,N,I)=>N in P?pe(P,N,{enumerable:!0,configurable:!0,writable:!0,value:I}):P[N]=I;var R=(P,N,I)=>be(P,typeof N!="symbol"?N+"":N,I);var P=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function N(d){return d&&d.__esModule&&Object.prototype.hasOwnProperty.call(d,"default")?d.default:d}var I={exports:{}};(function(d,e){(function(t,n){n(d)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:P,function(t){var n,o;if(!((o=(n=globalThis.chrome)==null?void 0:n.runtime)!=null&&o.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const s="The message port closed before a response was received.",r=a=>{const c={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(c).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class x extends WeakMap{constructor(l,u=void 0){super(u),this.createItem=l}get(l){return this.has(l)||this.set(l,this.createItem(l)),super.get(l)}}const T=i=>i&&typeof i=="object"&&typeof i.then=="function",C=(i,l)=>(...u)=>{a.runtime.lastError?i.reject(new Error(a.runtime.lastError.message)):l.singleCallbackArg||u.length<=1&&l.singleCallbackArg!==!1?i.resolve(u[0]):i.resolve(u)},y=i=>i==1?"argument":"arguments",M=(i,l)=>function(f,...p){if(p.length<l.minArgs)throw new Error(`Expected at least ${l.minArgs} ${y(l.minArgs)} for ${i}(), got ${p.length}`);if(p.length>l.maxArgs)throw new Error(`Expected at most ${l.maxArgs} ${y(l.maxArgs)} for ${i}(), got ${p.length}`);return new Promise((h,b)=>{if(l.fallbackToNoCallback)try{f[i](...p,C({resolve:h,reject:b},l))}catch(g){console.warn(`${i} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,g),f[i](...p),l.fallbackToNoCallback=!1,l.noCallback=!0,h()}else l.noCallback?(f[i](...p),h()):f[i](...p,C({resolve:h,reject:b},l))})},S=(i,l,u)=>new Proxy(l,{apply(f,p,h){return u.call(p,i,...h)}});let E=Function.call.bind(Object.prototype.hasOwnProperty);const O=(i,l={},u={})=>{let f=Object.create(null),p={has(b,g){return g in i||g in f},get(b,g,v){if(g in f)return f[g];if(!(g in i))return;let w=i[g];if(typeof w=="function")if(typeof l[g]=="function")w=S(i,i[g],l[g]);else if(E(u,g)){let _=M(g,u[g]);w=S(i,i[g],_)}else w=w.bind(i);else if(typeof w=="object"&&w!==null&&(E(l,g)||E(u,g)))w=O(w,l[g],u[g]);else if(E(u,"*"))w=O(w,l[g],u["*"]);else return Object.defineProperty(f,g,{configurable:!0,enumerable:!0,get(){return i[g]},set(_){i[g]=_}}),w;return f[g]=w,w},set(b,g,v,w){return g in f?f[g]=v:i[g]=v,!0},defineProperty(b,g,v){return Reflect.defineProperty(f,g,v)},deleteProperty(b,g){return Reflect.deleteProperty(f,g)}},h=Object.create(i);return new Proxy(h,p)},F=i=>({addListener(l,u,...f){l.addListener(i.get(u),...f)},hasListener(l,u){return l.hasListener(i.get(u))},removeListener(l,u){l.removeListener(i.get(u))}}),ee=new x(i=>typeof i!="function"?i:function(u){const f=O(u,{},{getContent:{minArgs:0,maxArgs:0}});i(f)}),z=new x(i=>typeof i!="function"?i:function(u,f,p){let h=!1,b,g=new Promise(L=>{b=function(k){h=!0,L(k)}}),v;try{v=i(u,f,b)}catch(L){v=Promise.reject(L)}const w=v!==!0&&T(v);if(v!==!0&&!w&&!h)return!1;const _=L=>{L.then(k=>{p(k)},k=>{let se;k&&(k instanceof Error||typeof k.message=="string")?se=k.message:se="An unexpected error occurred",p({__mozWebExtensionPolyfillReject__:!0,message:se})}).catch(k=>{console.error("Failed to send onMessage rejected reply",k)})};return _(w?v:g),!0}),te=({reject:i,resolve:l},u)=>{a.runtime.lastError?a.runtime.lastError.message===s?l():i(new Error(a.runtime.lastError.message)):u&&u.__mozWebExtensionPolyfillReject__?i(new Error(u.message)):l(u)},B=(i,l,u,...f)=>{if(f.length<l.minArgs)throw new Error(`Expected at least ${l.minArgs} ${y(l.minArgs)} for ${i}(), got ${f.length}`);if(f.length>l.maxArgs)throw new Error(`Expected at most ${l.maxArgs} ${y(l.maxArgs)} for ${i}(), got ${f.length}`);return new Promise((p,h)=>{const b=te.bind(null,{resolve:p,reject:h});f.push(b),u.sendMessage(...f)})},m={devtools:{network:{onRequestFinished:F(ee)}},runtime:{onMessage:F(z),onMessageExternal:F(z),sendMessage:B.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:B.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},A={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return c.privacy={network:{"*":A},services:{"*":A},websites:{"*":A}},O(a,m,c)};t.exports=r(chrome)}else t.exports=globalThis.browser})})(I);var ae=I.exports;const re=N(ae);function we(d){return d}const ie={"zh-CN":/[\u4e00-\u9fa5]/,ja:/[\u3040-\u309f\u30a0-\u30ff]/,ko:/[\uac00-\ud7af]/,ru:/[\u0400-\u04ff]/,ar:/[\u0600-\u06ff]/,th:/[\u0e00-\u0e7f]/};class oe{constructor(){this.sampleSize=200,this.confidenceThreshold=.3}detect(e){if(!e||e.trim().length===0)return{detected:"en",confidence:0};const t=this.getSampleText(e),n=this.analyzeSample(t);if(n.length===0)return{detected:"en",confidence:0};const o=n[0];return o.confidence<this.confidenceThreshold?{detected:"en",confidence:0}:o}getSampleText(e){return e.replace(/\s+/g," ").replace(/[^\w\s\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\u0400-\u04ff\u0600-\u06ff\u0e00-\u0e7f]/g,"").trim().slice(0,this.sampleSize)}analyzeSample(e){const t=[];for(const[n,o]of Object.entries(ie)){const s=e.match(new RegExp(o.source,"g")),r=s?s.length:0,a=r/e.length;r>0&&t.push({detected:n,confidence:a})}return t.sort((n,o)=>o.confidence-n.confidence)}detectPageLanguage(){var s;const e=document.documentElement.lang;if(e&&e!=="en")return e;const t=document.querySelector('meta[http-equiv="Content-Language"]');if(t){const r=t.getAttribute("content");if(r&&r!=="en")return r}const n=((s=document.body)==null?void 0:s.textContent)||"";return this.detect(n).detected}shouldTranslate(e){const t=this.detectPageLanguage();return!(t===e||t.startsWith(e)||e.startsWith(t))}}const D=new oe,$=re,U="trans_cache_",W="trans_cache_index";class le{constructor(){this.cacheIndex=new Map,this.maxAge=6048e5}async init(e){e&&(this.maxAge=e);const t=await $.storage.local.get(W);this.cacheIndex=new Map(Object.entries(t[W]||{})),await this.cleanExpired()}generateHash(e,t,n,o){return`${t}:${n}:${o}:${this.hashCode(e)}`}hashCode(e){let t=0;for(let n=0;n<e.length;n++){const o=e.charCodeAt(n);t=(t<<5)-t+o,t=t&t}return Math.abs(t)}async get(e,t,n,o){const s=this.generateHash(e,t,n,o),r=`${U}${s}`,c=(await $.storage.local.get(r))[r];return c?Date.now()-c.timestamp>this.maxAge?(await this.delete(s),null):c:null}async set(e,t,n,o,s){const r=this.generateHash(e,t,n,o),a=`${U}${r}`,c={originalText:e,translatedText:s,sourceLang:t,targetLang:n,model:o,timestamp:Date.now(),hash:r};await $.storage.local.set({[a]:c}),this.cacheIndex.set(r,c.timestamp),await this.saveIndex(),await this.cleanOldEntries()}async delete(e){const t=`${U}${e}`;await $.storage.local.remove(t),this.cacheIndex.delete(e),await this.saveIndex()}async clear(){const t=Array.from(this.cacheIndex.keys()).map(n=>`${U}${n}`);await $.storage.local.remove([...t,W]),this.cacheIndex.clear()}async saveIndex(){const e=Object.fromEntries(this.cacheIndex);await $.storage.local.set({[W]:e})}async cleanExpired(){const e=Date.now(),t=[];for(const[n,o]of this.cacheIndex.entries())e-o>this.maxAge&&t.push(n);for(const n of t)await this.delete(n)}async cleanOldEntries(){if(this.cacheIndex.size<=1e4)return;const t=Array.from(this.cacheIndex.entries()).sort((o,s)=>o[1]-s[1]),n=t.slice(0,t.length-1e4);for(const[o]of n)await this.delete(o)}async getStats(){if(this.cacheIndex.size===0)return{size:0,oldestTimestamp:0,newestTimestamp:0};const e=Array.from(this.cacheIndex.values());return{size:this.cacheIndex.size,oldestTimestamp:Math.min(...e),newestTimestamp:Math.max(...e)}}}const j=new le;class ge{constructor(e){this.activeRequests=new Map,this.requestQueue=[],this.config=e}updateConfig(e){this.config={...this.config,...e}}async translate(e){const t=e.model||this.config.models[0],n=`${e.sourceLang}:${e.targetLang}:${t}`;this.config.maxConcurrency>0&&await this.waitSlot();try{const o=await j.get(e.text,e.sourceLang,e.targetLang,t);if(o)return{originalText:e.text,translatedText:o.translatedText,sourceLang:e.sourceLang,targetLang:e.targetLang,model:o.model,cached:!0};const s=new AbortController,r=`${n}:${Date.now()}`;this.activeRequests.set(r,s);const a=await this.translateWithModel(e.text,e.sourceLang,e.targetLang,t,s.signal);return await j.set(e.text,e.sourceLang,e.targetLang,t,a),this.activeRequests.delete(r),this.releaseSlot(),{originalText:e.text,translatedText:a,sourceLang:e.sourceLang,targetLang:e.targetLang,model:t,cached:!1}}catch(o){throw this.releaseSlot(),o}}async translateBatch(e){if(e.length===0)return[];const t=e[0].model||this.config.models[0];if(this.config.models.length>1)return this.translateBatchWithMultipleModels(e);const n=Math.min(this.config.maxConcurrency||1,e.length),o=[];for(let s=0;s<e.length;s+=n){const r=e.slice(s,s+n),a=await Promise.allSettled(r.map(c=>this.translate(c)));for(const c of a)c.status==="fulfilled"?o.push(c.value):o.push({originalText:e[o.length].text,translatedText:e[o.length].text,sourceLang:e[o.length].sourceLang,targetLang:e[o.length].targetLang,model:t,cached:!1})}return o}async translateBatchWithMultipleModels(e){const t=Math.ceil((this.config.maxConcurrency||1)/this.config.models.length),n=[];for(const o of this.config.models){const s=e.filter(a=>!a.model||a.model===o);if(s.length===0)continue;const r=[];for(let a=0;a<s.length;a+=t)r.push(s.slice(a,a+t));for(const a of r){const c=await Promise.allSettled(a.map(x=>this.translate({...x,model:o})));for(const x of c)x.status==="fulfilled"?n.push(x.value):n.push({originalText:e[n.length].text,translatedText:e[n.length].text,sourceLang:e[n.length].sourceLang,targetLang:e[n.length].targetLang,model:o,cached:!1})}}return n}async translateWithModel(e,t,n,o,s){const r=this.buildPrompt(e,t,n),a={model:o,messages:[{role:"system",content:"You are a professional translator. Translate given text accurately while preserving original meaning and tone."},{role:"user",content:r}],temperature:.3,max_tokens:2e3};let c=this.config.baseUrl;c.endsWith("/chat/completions")||(c=c.replace(/\/$/,"")+"/chat/completions");const x=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(a),signal:s});if(!x.ok){const C=await x.text();throw new Error(`OpenAI API error: ${x.status} - ${C}`)}const T=await x.json();if(!T.choices||T.choices.length===0)throw new Error("No translation returned from OpenAI API");return T.choices[0].message.content.trim()}buildPrompt(e,t,n){return`Translate the following text from ${t} to ${n}:

${e}

Provide only the translation, no explanations.`}async waitSlot(){if(!(this.activeRequests.size<this.config.maxConcurrency))return new Promise(t=>{this.requestQueue.push(t)})}releaseSlot(){const e=this.requestQueue.shift();e&&e()}cancelAll(){for(const e of this.activeRequests.values())e.abort();this.activeRequests.clear(),this.requestQueue=[]}getActiveRequestCount(){return this.activeRequests.size}}let J=null;function G(d){return!J&&d&&(J=new ge(d)),J}const ce={matches:["<all_urls>"],runAt:"document_idle",main(){const d=re;console.log("[Content Script] Loading...");let e=!1;d.runtime.onMessage.addListener((o,s,r)=>{if(console.log("[Content Script] Received message:",o.type,"Initialized:",e),o.type==="getSettings")window.__TRANSLATION_MANAGER__?r(window.__TRANSLATION_MANAGER__.getSettings()):r({error:"Manager not ready yet"});else if(o.type==="updateSettings"){if(window.__TRANSLATION_MANAGER__)return window.__TRANSLATION_MANAGER__.updateSettings(o.settings).then(()=>{r({success:!0})}).catch(a=>{console.error("[Content Script] Update settings failed:",a),r({success:!1,error:a.message})}),!0;r({error:"Manager not ready yet"})}else if(o.type==="translatePage"){if(window.__TRANSLATION_MANAGER__)return console.log("[Content Script] Starting translation..."),window.__TRANSLATION_MANAGER__.translatePage().then(()=>{console.log("[Content Script] Translation completed"),r({success:!0})}).catch(a=>{console.error("[Content Script] Translation failed:",a),r({success:!1,error:a.message})}),!0;console.warn("[Content Script] Manager not ready, queueing translation..."),setTimeout(()=>{window.__TRANSLATION_MANAGER__?window.__TRANSLATION_MANAGER__.translatePage().then(()=>{r({success:!0})}).catch(a=>{r({success:!1,error:a.message})}):r({success:!1,error:"Manager still not ready"})},500)}else if(o.type==="getStatus")window.__TRANSLATION_MANAGER__?r({status:window.__TRANSLATION_MANAGER__.getStatus()}):r({status:"idle"});else if(o.type==="revertAll"){if(window.__TRANSLATION_MANAGER__)return window.__TRANSLATION_MANAGER__.revertAll().then(()=>{r({success:!0})}).catch(a=>{console.error("[Content Script] Revert all failed:",a),r({success:!1,error:a.message})}),!0;r({error:"Manager not ready yet"})}else if(o.type==="clearCache")return j.clear().then(()=>{var a,c;window.__TRANSLATION_MANAGER__&&((c=(a=window.__TRANSLATION_MANAGER__.translatedElements)==null?void 0:a.clear)==null||c.call(a)),r({success:!0}),setTimeout(()=>location.reload(),100)}).catch(a=>{console.error("[Content Script] Clear cache failed:",a),r({success:!1,error:a.message})}),!0;return!0});class t{constructor(){this.settings={enabled:!0,autoDetect:!0,targetLanguage:"zh-CN",openai:{apiKey:"",baseUrl:"https://api.openai.com/v1",models:["gpt-3.5-turbo"],maxConcurrency:5,timeout:3e4},cacheEnabled:!0,cacheMaxAge:7*24*60*60*1e3,blacklist:[],whitelist:[],showTranslationBadge:!0},this.status="idle",this.translatedElements=new Set,this.observer=null,this.pendingTranslations=new Set}async init(){console.log("[TranslationManager] Initializing..."),await this.loadSettings(),this.settings.cacheEnabled&&await j.init(this.settings.cacheMaxAge),this.settings.openai.apiKey&&(G(this.settings.openai),console.log("[TranslationManager] OpenAI service initialized with models:",this.settings.openai.models)),this.setupObserver(),e=!0,console.log("[TranslationManager] Initialization completed")}async loadSettings(){const s=await d.storage.local.get("settings");console.log("[TranslationManager] Loaded settings:",s.settings),this.settings={...this.settings,...s.settings}}async saveSettings(){await d.storage.local.set({settings:this.settings})}async updateSettings(s){console.log("[TranslationManager] Updating settings:",s),this.settings={...this.settings,...s},await this.saveSettings(),s.openai&&(G(s.openai),console.log("[TranslationManager] OpenAI config updated"))}getSettings(){return{...this.settings}}async translatePage(){if(!this.settings.enabled){console.log("[TranslationManager] Translation disabled");return}if(!this.settings.openai.apiKey){console.warn("[TranslationManager] API key not configured");return}if(this.status="detecting",this.settings.autoDetect){const r=D.detectPageLanguage();if(console.log("[TranslationManager] Page language:",r),!D.shouldTranslate(this.settings.targetLanguage)){console.log("[TranslationManager] Translation not needed"),this.status="idle";return}}this.status="translating",console.log("[TranslationManager] Starting translation...");const s=this.findTranslatableElements();console.log("[TranslationManager] Found",s.length,"translatable elements"),await this.translateElements(s),this.status="completed",console.log("[TranslationManager] Translation completed")}findTranslatableElements(){const s=[],r=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:c=>{var y;let x=c.parentElement;if(!x)return NodeFilter.FILTER_REJECT;const T=(y=c.textContent)==null?void 0:y.trim();return!T||T.length<2||this.hasExcludedAncestor(x)?NodeFilter.FILTER_REJECT:this.findTranslatableParent(x)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}});let a;for(;a=r.nextNode();){let c=a.parentElement;if(c){if(this.hasExcludedAncestor(c))continue;const x=this.findTranslatableParent(c);x&&s.push(x)}}return[...new Set(s)]}findTranslatableParent(s){let r=s;for(;r&&r!==document.body;){const a=r.tagName.toLowerCase();if(!this.shouldTranslateElement(r))return null;if(["p","div","span","li","td","h1","h2","h3","h4","h5","h6","a","button","section","article"].includes(a))return r;r=r.parentElement}return null}shouldTranslateElement(s){const r=s.tagName.toLowerCase();if(["script","style","noscript","iframe","svg","canvas","video","audio","code","pre","kbd","samp"].includes(r)||s.getAttribute("translate")==="no"||s.getAttribute("data-translate")==="false")return!1;const c=s.className;return!(typeof c=="string"&&c.includes("notranslate"))}hasExcludedAncestor(s){let r=s;for(;r&&r!==document.body;){const a=r.tagName.toLowerCase();if(["code","pre","kbd","samp"].includes(a)||r.getAttribute("translate")==="no"||r.getAttribute("data-translate")==="false"||typeof r.className=="string"&&r.className.includes("notranslate"))return!0;r=r.parentElement}return!1}async translateElements(s){var C;const r=G();if(!r){console.error("[TranslationManager] OpenAI service not available");return}const a=[];for(const y of s){if(this.translatedElements.has(y))continue;const M=(C=y.textContent)==null?void 0:C.trim();if(!M||M.length<3)continue;const S=this.hashText(M);if(this.pendingTranslations.has(S))continue;this.pendingTranslations.add(S);const E=this.settings.autoDetect?D.detect(M).detected:D.detectPageLanguage();a.push({text:M,sourceLang:E,targetLang:this.settings.targetLanguage,element:y})}if(a.length===0){console.log("[TranslationManager] No elements to translate");return}console.log("[TranslationManager] Translating",a.length,"texts");let c=0;const x=a.length,T=Math.min(5,this.settings.openai.maxConcurrency||5);for(let y=0;y<a.length;y+=T){const M=a.slice(y,y+T);await Promise.allSettled(M.map(async S=>{try{const E=await r.translate({text:S.text,sourceLang:S.sourceLang,targetLang:S.targetLang});E&&E.translatedText!==E.originalText&&this.applyTranslation(S.element,S.text,E.translatedText),c++,console.log(`[TranslationManager] Translated ${c}/${x}`)}catch(E){console.error("[TranslationManager] Translation failed for:",S.text,E)}finally{const E=this.hashText(S.text);this.pendingTranslations.delete(E)}}))}console.log("[TranslationManager] Translation completed, total:",c)}applyTranslation(s,r,a){if(this.translatedElements.has(s))return;s.setAttribute("data-at-original",r),s.setAttribute("data-at-translated",a);const c=Array.from(s.childNodes);for(const x of c)if(x.nodeType===Node.TEXT_NODE){const T=x.textContent||"";if(T.includes(r)){const C=T.replace(r,a);x.textContent=C}}this.translatedElements.add(s),this.settings.showTranslationBadge&&this.addTranslationBadge(s)}addTranslationBadge(s){if(s.querySelector(".at-badge"))return;window.getComputedStyle(s).position==="static"&&(s.style.position="relative");const c=document.createElement("span");c.className="at-badge",c.innerHTML=`
          <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
            <path d="M4.5 2A2.5 2.5 0 002 4.5v8A2.5 2.5 0 004.5 15h8a2.5 2.5 0 002.5-2.5v-8A2.5 2.5 0 0012.5 2h-8zm4 3a.5.5 0 01.5.5V8h1a.5.5 0 010-1H4.5z"/>
          </svg>
        `,c.style.cssText=`
          position: absolute;
          top: -4px;
          right: -4px;
          background: #3b82f6;
          color: white;
          border-radius: 4px;
          padding: 2px 4px;
          font-size: 10px;
          cursor: pointer;
          z-index: 10000;
          display: flex;
          align-items: center;
          gap: 2px;
        `,c.addEventListener("click",x=>{x.stopPropagation(),this.revertTranslation(s)}),s.appendChild(c)}revertTranslation(s){const r=s.getAttribute("data-at-original"),a=s.getAttribute("data-at-translated");if(r&&a){const c=Array.from(s.childNodes);for(const T of c)if(T.nodeType===Node.TEXT_NODE){const C=T.textContent||"";C.includes(a)&&(T.textContent=C.replace(a,r))}s.removeAttribute("data-at-original"),s.removeAttribute("data-at-translated"),this.translatedElements.delete(s);const x=s.querySelector(".at-badge");x&&x.remove()}}setupObserver(){this.observer||(this.observer=new MutationObserver(this.debounce(()=>{if(this.status==="completed"){console.log("[TranslationManager] Page changed, re-translating...");const s=this.findTranslatableElements();this.translateElements(s)}},500)),this.observer.observe(document.body,{childList:!0,subtree:!0}))}debounce(s,r){let a=null;return(...c)=>{a&&clearTimeout(a),a=window.setTimeout(()=>s(...c),r)}}hashText(s){let r=0;for(let a=0;a<s.length;a++)r=(r<<5)-r+s.charCodeAt(a),r=r&r;return Math.abs(r).toString()}getStatus(){return this.status}async revertAll(){console.log("[TranslationManager] Reverting all translations...");const s=Array.from(this.translatedElements);for(const r of s)this.revertTranslation(r);this.translatedElements.clear(),this.status="idle",console.log("[TranslationManager] All translations reverted")}}const n=new t;window.__TRANSLATION_MANAGER__=n,typeof window<"u"&&window.__DEBUG__&&(window.__DEBUG__.registerModule("translationManager",n),window.__DEBUG__.registerModule("languageDetector",D),window.__DEBUG__.registerModule("openaiService",G()),window.__DEBUG__.registerModule("translationCache",j)),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{console.log("[Content Script] DOM loaded, initializing manager..."),n.init()}):(console.log("[Content Script] DOM already loaded, initializing manager immediately..."),n.init())}};var ne={exports:{}};(function(d,e){(function(t,n){n(d)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:P,function(t){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)t.exports=globalThis.browser;else{const n="The message port closed before a response was received.",o=s=>{const r={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(r).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class a extends WeakMap{constructor(A,i=void 0){super(i),this.createItem=A}get(A){return this.has(A)||this.set(A,this.createItem(A)),super.get(A)}}const c=m=>m&&typeof m=="object"&&typeof m.then=="function",x=(m,A)=>(...i)=>{s.runtime.lastError?m.reject(new Error(s.runtime.lastError.message)):A.singleCallbackArg||i.length<=1&&A.singleCallbackArg!==!1?m.resolve(i[0]):m.resolve(i)},T=m=>m==1?"argument":"arguments",C=(m,A)=>function(l,...u){if(u.length<A.minArgs)throw new Error(`Expected at least ${A.minArgs} ${T(A.minArgs)} for ${m}(), got ${u.length}`);if(u.length>A.maxArgs)throw new Error(`Expected at most ${A.maxArgs} ${T(A.maxArgs)} for ${m}(), got ${u.length}`);return new Promise((f,p)=>{if(A.fallbackToNoCallback)try{l[m](...u,x({resolve:f,reject:p},A))}catch(h){console.warn(`${m} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,h),l[m](...u),A.fallbackToNoCallback=!1,A.noCallback=!0,f()}else A.noCallback?(l[m](...u),f()):l[m](...u,x({resolve:f,reject:p},A))})},y=(m,A,i)=>new Proxy(A,{apply(l,u,f){return i.call(u,m,...f)}});let M=Function.call.bind(Object.prototype.hasOwnProperty);const S=(m,A={},i={})=>{let l=Object.create(null),u={has(p,h){return h in m||h in l},get(p,h,b){if(h in l)return l[h];if(!(h in m))return;let g=m[h];if(typeof g=="function")if(typeof A[h]=="function")g=y(m,m[h],A[h]);else if(M(i,h)){let v=C(h,i[h]);g=y(m,m[h],v)}else g=g.bind(m);else if(typeof g=="object"&&g!==null&&(M(A,h)||M(i,h)))g=S(g,A[h],i[h]);else if(M(i,"*"))g=S(g,A[h],i["*"]);else return Object.defineProperty(l,h,{configurable:!0,enumerable:!0,get(){return m[h]},set(v){m[h]=v}}),g;return l[h]=g,g},set(p,h,b,g){return h in l?l[h]=b:m[h]=b,!0},defineProperty(p,h,b){return Reflect.defineProperty(l,h,b)},deleteProperty(p,h){return Reflect.deleteProperty(l,h)}},f=Object.create(m);return new Proxy(f,u)},E=m=>({addListener(A,i,...l){A.addListener(m.get(i),...l)},hasListener(A,i){return A.hasListener(m.get(i))},removeListener(A,i){A.removeListener(m.get(i))}}),O=new a(m=>typeof m!="function"?m:function(i){const l=S(i,{},{getContent:{minArgs:0,maxArgs:0}});m(l)}),F=new a(m=>typeof m!="function"?m:function(i,l,u){let f=!1,p,h=new Promise(w=>{p=function(_){f=!0,w(_)}}),b;try{b=m(i,l,p)}catch(w){b=Promise.reject(w)}const g=b!==!0&&c(b);if(b!==!0&&!g&&!f)return!1;const v=w=>{w.then(_=>{u(_)},_=>{let L;_&&(_ instanceof Error||typeof _.message=="string")?L=_.message:L="An unexpected error occurred",u({__mozWebExtensionPolyfillReject__:!0,message:L})}).catch(_=>{console.error("Failed to send onMessage rejected reply",_)})};return v(g?b:h),!0}),ee=({reject:m,resolve:A},i)=>{s.runtime.lastError?s.runtime.lastError.message===n?A():m(new Error(s.runtime.lastError.message)):i&&i.__mozWebExtensionPolyfillReject__?m(new Error(i.message)):A(i)},z=(m,A,i,...l)=>{if(l.length<A.minArgs)throw new Error(`Expected at least ${A.minArgs} ${T(A.minArgs)} for ${m}(), got ${l.length}`);if(l.length>A.maxArgs)throw new Error(`Expected at most ${A.maxArgs} ${T(A.maxArgs)} for ${m}(), got ${l.length}`);return new Promise((u,f)=>{const p=ee.bind(null,{resolve:u,reject:f});l.push(p),i.sendMessage(...l)})},te={devtools:{network:{onRequestFinished:E(O)}},runtime:{onMessage:E(F),onMessageExternal:E(F),sendMessage:z.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:z.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},B={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return r.privacy={network:{"*":B},services:{"*":B},websites:{"*":B}},S(s,te,r)};t.exports=o(chrome)}})})(ne);var me=ne.exports;const H=N(me);function V(d,...e){}const Ae={debug:(...d)=>V(console.debug,...d),log:(...d)=>V(console.log,...d),warn:(...d)=>V(console.warn,...d),error:(...d)=>V(console.error,...d)},Z=class Z extends Event{constructor(e,t){super(Z.EVENT_NAME,{}),this.newUrl=e,this.oldUrl=t}};R(Z,"EVENT_NAME",Q("wxt:locationchange"));let X=Z;function Q(d){var e;return`${(e=H==null?void 0:H.runtime)==null?void 0:e.id}:content:${d}`}function ue(d){let e,t;return{run(){e==null&&(t=new URL(location.href),e=d.setInterval(()=>{let n=new URL(location.href);n.href!==t.href&&(window.dispatchEvent(new X(n,t)),t=n)},1e3))}}}const K=class K{constructor(e,t){R(this,"isTopFrame",window.self===window.top);R(this,"abortController");R(this,"locationWatcher",ue(this));R(this,"receivedMessageIds",new Set);this.contentScriptName=e,this.options=t,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(e){return this.abortController.abort(e)}get isInvalid(){return H.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(e){return this.signal.addEventListener("abort",e),()=>this.signal.removeEventListener("abort",e)}block(){return new Promise(()=>{})}setInterval(e,t){const n=setInterval(()=>{this.isValid&&e()},t);return this.onInvalidated(()=>clearInterval(n)),n}setTimeout(e,t){const n=setTimeout(()=>{this.isValid&&e()},t);return this.onInvalidated(()=>clearTimeout(n)),n}requestAnimationFrame(e){const t=requestAnimationFrame((...n)=>{this.isValid&&e(...n)});return this.onInvalidated(()=>cancelAnimationFrame(t)),t}requestIdleCallback(e,t){const n=requestIdleCallback((...o)=>{this.signal.aborted||e(...o)},t);return this.onInvalidated(()=>cancelIdleCallback(n)),n}addEventListener(e,t,n,o){var s;t==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),(s=e.addEventListener)==null||s.call(e,t.startsWith("wxt:")?Q(t):t,n,{...o,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),Ae.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:K.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(e){var s,r,a;const t=((s=e.data)==null?void 0:s.type)===K.SCRIPT_STARTED_MESSAGE_TYPE,n=((r=e.data)==null?void 0:r.contentScriptName)===this.contentScriptName,o=!this.receivedMessageIds.has((a=e.data)==null?void 0:a.messageId);return t&&n&&o}listenForNewerScripts(e){let t=!0;const n=o=>{if(this.verifyScriptStartedEvent(o)){this.receivedMessageIds.add(o.data.messageId);const s=t;if(t=!1,s&&(e!=null&&e.ignoreFirstEvent))return;this.notifyInvalidated()}};addEventListener("message",n),this.onInvalidated(()=>removeEventListener("message",n))}};R(K,"SCRIPT_STARTED_MESSAGE_TYPE",Q("wxt:content-script-started"));let Y=K;const de=Symbol("null");let he=0;class fe extends Map{constructor(){super(),this._objectHashes=new WeakMap,this._symbolHashes=new Map,this._publicKeys=new Map;const[e]=arguments;if(e!=null){if(typeof e[Symbol.iterator]!="function")throw new TypeError(typeof e+" is not iterable (cannot read property Symbol(Symbol.iterator))");for(const[t,n]of e)this.set(t,n)}}_getPublicKeys(e,t=!1){if(!Array.isArray(e))throw new TypeError("The keys parameter must be an array");const n=this._getPrivateKey(e,t);let o;return n&&this._publicKeys.has(n)?o=this._publicKeys.get(n):t&&(o=[...e],this._publicKeys.set(n,o)),{privateKey:n,publicKey:o}}_getPrivateKey(e,t=!1){const n=[];for(let o of e){o===null&&(o=de);const s=typeof o=="object"||typeof o=="function"?"_objectHashes":typeof o=="symbol"?"_symbolHashes":!1;if(!s)n.push(o);else if(this[s].has(o))n.push(this[s].get(o));else if(t){const r=`@@mkm-ref-${he++}@@`;this[s].set(o,r),n.push(r)}else return!1}return JSON.stringify(n)}set(e,t){const{publicKey:n}=this._getPublicKeys(e,!0);return super.set(n,t)}get(e){const{publicKey:t}=this._getPublicKeys(e);return super.get(t)}has(e){const{publicKey:t}=this._getPublicKeys(e);return super.has(t)}delete(e){const{publicKey:t,privateKey:n}=this._getPublicKeys(e);return!!(t&&super.delete(t)&&this._publicKeys.delete(n))}clear(){super.clear(),this._symbolHashes.clear(),this._publicKeys.clear()}get[Symbol.toStringTag](){return"ManyKeysMap"}get size(){return super.size}}new fe;function ye(){}function q(d,...e){}const xe={debug:(...d)=>q(console.debug,...d),log:(...d)=>q(console.log,...d),warn:(...d)=>q(console.warn,...d),error:(...d)=>q(console.error,...d)};return(async()=>{try{const{main:d,...e}=ce,t=new Y("content",e);return await d(t)}catch(d){throw xe.error('The content script "content" crashed on startup!',d),d}})()}();
content;
