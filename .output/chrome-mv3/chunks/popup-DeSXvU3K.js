import{d as N,o as q,w as T,a as u,c as p,b as o,n as $,t as v,e as m,v as P,g as z,F as R,r as U,f as V,i as y,j as f,l as h,_ as I,k as E}from"./_plugin-vue_export-helper-DkOLU9r1.js";const K={class:"popup-container"},B={class:"popup-header"},j={class:"popup-content"},O={class:"toggle-section"},G={class:"toggle-label"},H={key:0,class:"settings-section"},J={class:"control-group"},Q=["value"],X={class:"control-group"},Y={class:"button-group"},Z={key:1,class:"translate-btn",disabled:""},ee={key:2,class:"completed-actions"},te={key:1,class:"api-status"},se=N({__name:"App",setup(oe){const n=T,k=[{code:"zh-CN",name:"简体中文"},{code:"zh-TW",name:"繁體中文"},{code:"en",name:"English"},{code:"ja",name:"日本語"},{code:"ko",name:"한국어"},{code:"fr",name:"Français"},{code:"de",name:"Deutsch"},{code:"es",name:"Español"}],l=f({enabled:!0,autoDetect:!0,targetLanguage:"zh-CN"}),r=f("idle"),d=f(!1),C=h(()=>["detecting","translating"].includes(r.value)),_=h(()=>({idle:"就绪",detecting:"检测中...",translating:"翻译中...",completed:"已完成",error:"错误"})[r.value]),x=h(()=>({idle:"status-idle",detecting:"status-detecting",translating:"status-translating",completed:"status-completed",error:"status-error"})[r.value]);q(async()=>{await M(),await F(),await L(),await S()});async function S(){try{const s=await n.tabs.query({active:!0,currentWindow:!0});if(s[0]){const e=s[0].url;console.log("[Popup] Current tab URL:",e),["chrome://extensions/","chrome://newtab/","about:blank","edge://extensions/","edge://newtab/","moz-extension://"].some(a=>e==null?void 0:e.startsWith(a))&&console.warn("[Popup] Currently on special page, translation may not work")}}catch(s){console.error("[Popup] Failed to check current tab:",s)}}async function M(){var e;const s=await n.tabs.query({active:!0,currentWindow:!0});if((e=s[0])!=null&&e.id)try{const t=await n.tabs.sendMessage(s[0].id,{type:"getSettings"});t?(l.value={enabled:t.enabled,autoDetect:t.autoDetect,targetLanguage:t.targetLanguage},console.log("[Popup] Settings loaded:",l.value)):console.warn("[Popup] No response from content script, may be on special page")}catch(t){console.error("[Popup] Failed to load settings:",t)}}async function F(){var s;try{const t=(await n.storage.local.get("settings")).settings,i=(s=t==null?void 0:t.openai)==null?void 0:s.apiKey;console.log("[Popup] Checking API key:",!!i,i?`${i.substring(0,8)}...`:"none"),d.value=!!(i&&i.length>0)}catch(e){console.error("[Popup] Failed to check API key:",e),d.value=!1}}async function L(){var e;const s=await n.tabs.query({active:!0,currentWindow:!0});if((e=s[0])!=null&&e.id)try{const t=await n.tabs.sendMessage(s[0].id,{type:"getStatus"});t!=null&&t.status&&(r.value=t.status)}catch(t){console.error("[Popup] Failed to check status:",t)}}async function W(){await g()}async function g(){var e;const s=await n.tabs.query({active:!0,currentWindow:!0});if((e=s[0])!=null&&e.id)try{await n.tabs.sendMessage(s[0].id,{type:"updateSettings",settings:{enabled:l.value.enabled,autoDetect:l.value.autoDetect,targetLanguage:l.value.targetLanguage}}),console.log("[Popup] Settings updated")}catch(t){console.error("[Popup] Failed to update settings:",t),alert("更新设置失败，请重试")}}async function b(){const s=await n.tabs.query({active:!0,currentWindow:!0});if(!s[0]){console.error("[Popup] No active tab found"),alert("无法找到当前页面标签");return}const e=s[0];if(["chrome://extensions/","chrome://newtab/","about:blank","about:newtab","edge://extensions/","edge://newtab/","moz-extension://"].some(a=>{var c;return(c=e.url)==null?void 0:c.startsWith(a)})){console.warn("[Popup] Cannot translate special page:",e.url),alert(`请在正常网页上使用翻译功能
（如 https://example.com）`);return}r.value="translating",console.log("[Popup] Sending translate message to tab:",e.id,"URL:",e.url);try{const a=await n.tabs.sendMessage(e.id,{type:"translatePage"});if(console.log("[Popup] Translation response:",a),a&&a.success===!1){r.value="error";const c=a.error||"未知错误";alert(`翻译失败: ${c}`)}else r.value="completed"}catch(a){console.error("[Popup] Failed to translate:",a),r.value="error",a.message.includes("Receiving end does not exist")?(console.error("[Popup] Message channel closed, tab may be closing or reloading"),alert("页面正在加载或已关闭，请刷新页面后重试")):a.message.includes("Could not establish connection")?(console.error("[Popup] Cannot connect to content script"),alert(`无法建立连接，content script 可能未加载
请刷新页面或重新加载插件`)):alert(`翻译失败: ${a.message||"未知错误"}
请刷新页面后重试`)}}async function A(){const s=await n.tabs.query({active:!0,currentWindow:!0});if(!s[0]){console.error("[Popup] No active tab found"),alert("无法找到当前页面标签");return}const e=s[0];console.log("[Popup] Sending revert message to tab:",e.id);try{const t=await n.tabs.sendMessage(e.id,{type:"revertAll"});console.log("[Popup] Revert response:",t),t&&t.success===!1?alert(`撤销翻译失败: ${t.error||"未知错误"}`):r.value="idle"}catch(t){console.error("[Popup] Failed to revert:",t),alert(`撤销翻译失败: ${t.message||"未知错误"}`)}}async function w(){await n.runtime.openOptionsPage()}async function D(){const s=await n.tabs.query({active:!0,currentWindow:!0});if(!s[0]){alert("无法找到当前页面标签");return}const e=s[0];if(["chrome://extensions/","chrome://newtab/","about:blank","edge://extensions/","edge://newtab/"].some(a=>{var c;return(c=e.url)==null?void 0:c.startsWith(a)})){alert("清除缓存操作仅在正常网页上可用");return}console.log("[Popup] Sending clear cache message to tab:",e.id,"URL:",e.url);try{const a=await n.tabs.sendMessage(e.id,{type:"clearCache"});if(console.log("[Popup] Clear cache response:",a),a&&a.success===!1){const c=a.error||"未知错误";alert(`清除缓存失败: ${c}`)}else alert("缓存已清除，页面将自动刷新")}catch(a){console.error("[Popup] Failed to clear cache:",a),a.message.includes("Receiving end does not exist")?alert("页面正在加载或已关闭，请刷新页面后重试"):a.message.includes("Could not establish connection")?alert(`无法建立连接，content script 可能未加载
请刷新页面或重新加载插件`):alert(`清除缓存失败: ${a.message}
请刷新页面后重试`)}}return(s,e)=>(u(),p("div",K,[o("header",B,[e[3]||(e[3]=o("h1",null,"自动翻译",-1)),o("div",{class:$(["status-indicator",x.value])},v(_.value),3)]),o("div",j,[o("div",O,[o("label",G,[m(o("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=t=>l.value.enabled=t),onChange:W},null,544),[[P,l.value.enabled]]),e[4]||(e[4]=o("span",{class:"toggle-slider"},null,-1)),e[5]||(e[5]=o("span",null,"启用自动翻译",-1))])]),l.value.enabled?(u(),p("div",H,[o("div",J,[e[6]||(e[6]=o("label",null,"目标语言",-1)),m(o("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>l.value.targetLanguage=t),onChange:g},[(u(),p(R,null,U(k,t=>o("option",{key:t.code,value:t.code},v(t.name),9,Q)),64))],544),[[z,l.value.targetLanguage]])]),o("div",X,[o("label",null,[m(o("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=t=>l.value.autoDetect=t),onChange:g},null,544),[[P,l.value.autoDetect]]),e[7]||(e[7]=V(" 自动检测语言 ",-1))])]),o("div",Y,[r.value==="idle"?(u(),p("button",{key:0,class:"translate-btn",onClick:b}," 翻译当前页面 ")):r.value==="translating"||r.value==="detecting"?(u(),p("button",Z,v(C.value?"翻译中...":"检测中..."),1)):r.value==="completed"?(u(),p("div",ee,[o("button",{class:"btn-success",onClick:A}," 撤销翻译 "),o("button",{class:"btn-secondary",onClick:b}," 重新翻译 ")])):r.value==="error"?(u(),p("button",{key:3,class:"btn-error",onClick:b}," 重试 ")):y("",!0)])])):y("",!0),d.value?y("",!0):(u(),p("div",te,[e[8]||(e[8]=o("p",{class:"warning"},"⚠️ 请先配置 OpenAI API 密钥",-1)),o("button",{class:"btn-secondary",onClick:w}," 前往设置 ")]))]),o("footer",{class:"popup-footer"},[o("button",{class:"btn-link",onClick:w},"设置"),o("button",{class:"btn-link",onClick:D},"清除缓存")])]))}}),ae=I(se,[["__scopeId","data-v-4108e4f6"]]);E(ae).mount("#app");
